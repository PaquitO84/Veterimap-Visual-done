<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil Profesional | Veterimap</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --brand: #1cabb0;
      --text: #1a1a1a;
      --muted: #666;
      --bg: #f5f8f9;
      --card: #ffffff;
      --line: #e5e7eb;
      --radius: 16px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px 20px 64px;
    }

    /* Estados de Carga */
    .skeleton {
      animation: pulse 1.2s ease-in-out infinite;
      background: linear-gradient(90deg, #eee, #f6f6f6, #eee);
      background-size: 200% 100%;
      border-radius: 8px;
    }
    @keyframes pulse { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 16px;
    }

    /* Header Profile */
    .header {
      display: grid;
      grid-template-columns: 100px 1fr;
      gap: 20px;
      align-items: center;
      padding: 24px;
    }
    .logo { width: 100px; height: 100px; border-radius: 16px; object-fit: cover; border: 1px solid var(--line); }
    .title-row { display: flex; flex-direction: column; gap: 4px; }
    .title { font-size: 24px; font-weight: 800; color: var(--brand); margin: 0; }
    .rating { font-size: 15px; color: #f1c40f; font-weight: 600; }

    /* Layout Grid */
    .grid { display: grid; gap: 20px; margin-top: 20px; }
    @media(min-width: 900px) { .grid { grid-template-columns: 1.5fr 1fr; } }

    .block { padding: 20px; }
    .block h3 { margin: 0 0 16px; font-size: 18px; color: var(--brand); border-bottom: 2px solid #e0f7f9; padding-bottom: 4px; }

    /* Tags & Info */
    .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag { background: #f0f7f7; color: #066b6e; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; border: 1px solid #d1eaea; }
    .tag-uci { background: #fff5f5; color: #c53030; border-color: #feb2b2; }

    .kv { display: grid; grid-template-columns: 110px 1fr; gap: 8px; font-size: 14px; margin-bottom: 4px; }
    .kv .label { color: var(--muted); font-weight: 600; }

    /* Botones de Acci√≥n */
    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }
    .btn { 
      padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; text-align: center;
      text-decoration: none; border: none; font-size: 14px; transition: 0.2s;
    }
    .btn-primary { background: var(--brand); color: #fff; }
    .btn-secondary { background: #e8f7f8; color: #066b6e; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }

    #map { height: 250px; border-radius: 12px; border: 1px solid var(--line); }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div class="wrap">
    <header class="card">
      <div class="header">
        <img id="logo" src="https://via.placeholder.com/100" class="logo" alt="Logo" />
        <div class="title-row">
          <h1 id="nombre" class="title">Cargando...</h1>
          <div id="rating" class="rating">‚≠ê 0.0 (0 rese√±as)</div>
          <div class="btn-group">
            <a id="link-phone" href="#" class="btn btn-primary">Llamar</a>
            <a id="link-email" href="#" class="btn btn-secondary">Email</a>
          </div>
        </div>
      </div>
    </header>

    <div class="grid">
      <div class="left">
        <div class="card block">
          <h3>Descripci√≥n</h3>
          <p id="descripcion" style="line-height: 1.6; color: #444;"></p>
        </div>

        <div class="card block">
          <h3>Servicios y Especialidades</h3>
          <div id="tags-servicios" class="tag-list"></div>
        </div>

        <div id="block-uci" class="card block hidden">
          <h3>Hospitalizaci√≥n y UCI</h3>
          <div id="tags-uci" class="tag-list"></div>
        </div>

        <div class="card block">
          <h3>Tarifas Orientativas</h3>
          <div id="lista-tarifas" style="font-size: 14px; line-height: 2;"></div>
        </div>
      </div>

      <div class="right">
        <div class="card block">
          <h3>Detalles de Contacto</h3>
          <div class="kv"><div class="label">üìç Direcci√≥n:</div><div id="val-address"></div></div>
          <div class="kv"><div class="label">üåÜ Ciudad:</div><div id="val-city"></div></div>
          <div class="kv"><div class="label">üïí Horario:</div><div id="val-horario"></div></div>
          <div class="kv"><div class="label">üéì Colegiado:</div><div id="val-license"></div></div>
          <div class="kv"><div class="label">üõ°Ô∏è Seguros:</div><div id="val-insurance"></div></div>
        </div>

        <div class="card block">
    <h3>Reserva de Cita</h3>
    <p style="font-size: 14px; color: var(--muted);">Agenda tu visita de forma r√°pida y sencilla.</p>
    <button id="vm-btn-reservar" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
        üìÖ Reservar Cita Online
    </button>
</div>

<div id="vm-modal" class="vm-modal" style="display:none; position:fixed; inset:0; z-index:9999; place-items:center;">
    <div class="vm-modal__backdrop" style="position:absolute; inset:0; background:rgba(0,0,0,0.5);"></div>
    <div class="vm-modal__card" style="position:relative; background:white; padding:24px; border-radius:16px; max-width:450px; width:90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
        <h3 id="vm-modal-title" style="margin-top:0; color:var(--brand);">Solicitar Cita</h3>
        <div id="vm-modal-content" style="margin: 15px 0; font-size:15px;">
            </div>
        <div style="display:flex; gap:10px; justify-content: flex-end;">
            <button id="vm-close" class="btn btn-secondary">Cerrar</button>
            <button id="vm-confirm" class="btn btn-primary hidden">Confirmar Cita</button>
        </div>
    </div>
</div>

        <div class="card block">
          <h3>Ubicaci√≥n</h3>
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 1. Obtener ID de la URL
    const params = new URLSearchParams(location.search);
    const profId = params.get('id');

    async function fetchProfile() {
      try {
        // Conexi√≥n a tu API de Go
        const response = await fetch(`http://localhost:8080/api/profiles/details?id=${profId}`);
        if (!response.ok) throw new Error("No se pudo cargar el perfil");
        
        const d = await response.json();
        renderData(d);
      } catch (err) {
        console.error(err);
        document.body.innerHTML = `<div style="padding:50px; text-align:center;"><h2>Perfil no encontrado</h2><a href="mapa.html">Volver al mapa</a></div>`;
      }
    }

    function renderData(d) {
    // 1. Header & Textos
    document.getElementById('nombre').textContent = d.name;
    
    // TRUCO: Separamos la descripci√≥n de las tarifas si vienen juntas
    const descParts = (d.description || "").split("Tarifas:");
    document.getElementById('descripcion').textContent = descParts[0].trim() || "Sin descripci√≥n disponible.";
    
    document.getElementById('val-address').textContent = d.address;
    document.getElementById('val-city').textContent = d.city;
    document.getElementById('val-horario').textContent = d.opening_hours;
    document.getElementById('val-license').textContent = d.license_number || "‚Äî";
    
    // 2. Logo
    if(d.logo_url) document.getElementById('logo').src = d.logo_url;

    // 3. Rating (con protecci√≥n por si d.rating es undefined)
    const r = d.rating || 0;
    const c = d.review_count || 0;
    document.getElementById('rating').textContent = `‚≠ê ${r.toFixed(1)} (${c} rese√±as)`;

    // 4. Seguros
    document.getElementById('val-insurance').textContent = d.accepts_insurance ? d.insurance_names : "No acepta aseguradoras";

    // 5. Botones de Acci√≥n
    document.getElementById('link-phone').href = `tel:${d.phone}`;
    document.getElementById('link-email').href = `mailto:${d.contact_email}`;

    // 6. Tags: Servicios (Leemos la lista que llega del servidor)
    const svcCont = document.getElementById('tags-servicios');
    svcCont.innerHTML = ""; // Limpiamos para evitar duplicados
    
    // Combinamos las listas por si el servidor a√∫n env√≠a diagnostic_tests por separado
    const allSvc = [...(d.services_list || []), ...(d.diagnostic_tests || [])];
    
    if (allSvc.length > 0) {
        allSvc.forEach(s => {
            svcCont.innerHTML += `<span class="tag">${s}</span>`;
        });
    }

    // 7. Tags: UCI (Mantenemos tu l√≥gica original)
    if(d.uci_services && d.uci_services.length > 0) {
        document.getElementById('block-uci').classList.remove('hidden');
        const uciCont = document.getElementById('tags-uci');
        uciCont.innerHTML = ""; 
        d.uci_services.forEach(u => {
            uciCont.innerHTML += `<span class="tag tag-uci">üö® ${u}</span>`;
        });
    }

    // 8. Tarifas (L√≥gica inteligente: si no hay campo 'tarifas', las saca de la descripci√≥n)
    const tCont = document.getElementById('lista-tarifas');
    tCont.innerHTML = ""; // Limpiar
    
    if(d.tarifas && d.tarifas.length > 0) {
        // Si el servidor env√≠a el array de tarifas directamente
        d.tarifas.forEach(t => tCont.innerHTML += `<div>‚Ä¢ ${t}</div>`);
    } else if (descParts.length > 1) {
        // Si las tarifas est√°n "escondidas" en la descripci√≥n
        const arrayTarifas = descParts[1].split("|");
        arrayTarifas.forEach(t => {
            if(t.trim() !== "") tCont.innerHTML += `<div>‚Ä¢ ${t.trim()}</div>`;
        });
    } else {
        tCont.innerHTML = "<span class='muted'>Consultar tarifas directamente.</span>";
    }

    // 9. Mapa Leaflet
    initMap(d.latitude, d.longitude, d.name);
}      // Mapa Leaflet
      

    function initMap(lat, lng, name) {
      const map = L.map('map', { scrollWheelZoom: false }).setView([lat, lng], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      L.marker([lat, lng]).addTo(map).bindPopup(name).openPopup();
    }

    if (profId) fetchProfile();
  </script>
</body>
</html>