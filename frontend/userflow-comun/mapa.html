<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veterimap | Buscador Inteligente</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --bg-blue: #2563eb; 
      --primary: #10b981; 
      --primary-hover: #059669;
      --vet-teal: #1cabb0; 
    }

    body { 
      margin: 0; 
      font-family: 'Inter', system-ui, sans-serif; 
      background-color: var(--bg-blue); 
      color: white; 
    }

    .page { max-width: 1200px; margin: 0 auto; padding: 16px; }

    /* === TOPBAR RESPONSIVE === */
    .vmap-topbar { display: flex; align-items: end; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    .vm-summary { font-weight: 700; color: #ffffff; font-size: 14px; padding: 6px 12px; border-radius: 10px; background: rgba(255, 255, 255, 0.12); line-height: 1.2; display: inline-block; margin-bottom: 10px; }
    .vm-inline { display: flex; align-items: end; gap: 8px; width: 100%; }
    label { display: flex; flex-direction: column; font-weight: 600; color: #ffffff; font-size: 13px; }
    select, input { margin-top: 4px; padding: 8px 14px; border-radius: 20px; border: 1px solid #e5e7eb; background: #fff; font-size: 14px; min-width: 180px; color: #333; outline: none; }
    #vm-apply { display: inline-flex; align-items: center; justify-content: center; width: 38px; height: 38px; border-radius: 10px; border: none; cursor: pointer; background: var(--primary); color: #fff; }

    @media (max-width: 720px) {
      .vmap-topbar .vm-inline { display: grid; grid-template-columns: 1fr 1fr 40px; gap: 8px; align-items: end; }
      .vmap-topbar select, .vmap-topbar input { min-width: 0; width: 100%; padding: 6px 12px; height: 36px; font-size: 12.5px; }
    }

    /* === LAYOUT === */
    .layout { display: flex; gap: 20px; margin-top: 20px; align-items: stretch; }
    #map { flex: 1; height: 600px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); }
    #vets-scroll-container { flex: 1; max-height: 600px; overflow-y: auto; padding-right: 6px; }

    /* === VET CARDS === */
    .vets-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    .vet-card { background: #fff; border-radius: 12px; padding: 18px; color: #111; cursor: pointer; transition: all 0.2s; border: 1px solid #e5e7eb; }
    .vet-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .vet-card.validated { border: 2.5px solid var(--vet-teal); background-color: #f0fdfa; }
    .vet-name { font-size: 1.1rem; font-weight: 700; color: #111; margin-bottom: 4px; display: flex; align-items: center; }
    .vet-card.validated .vet-name { color: var(--vet-teal); }
    .vet-address { color: #555; font-size: 13px; margin: 5px 0; }
    .vet-meta { margin-top: 8px; color: var(--vet-teal); font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 5px; }
    .verified-check { background: var(--vet-teal); color: #fff; font-size: 0.7rem; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; margin-left: 8px; }

    @media (max-width: 768px) {
      .layout { flex-direction: column; }
      #map { order: -1; width: 100%; height: 240px; margin-bottom: 12px; }
    }
  </style>
</head>
<body>

  <div class="page">
    <div class="vmap-topbar">
      <div id="vm-summary" class="vm-summary">Inicia tu b√∫squeda</div>
      <div class="vm-inline">
        <label>Ciudad:
          <input id="vm-city" list="citySuggestions" placeholder="Ej: Barcelona" autocomplete="off" />
          <datalist id="citySuggestions"></datalist>
        </label>
        <label>Servicio:
          <select id="vm-service">
            <option value="clinicas">Cl√≠nicas veterinarias</option>
            <option value="24h">Atenci√≥n 24H</option>
            <option value="domicilio">A domicilio</option>
            <option value="profesionales">Aut√≥nomos</option>
          </select>
        </label>
        <button id="vm-apply" title="Buscar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="20"><circle cx="11" cy="11" r="7"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>
      </div>
    </div>

    <div style="display:flex; gap:15px; margin-bottom: 20px; flex-wrap: wrap;">
      <label>Filtro por rating:
        <select id="filter-rating" style="min-width: 120px; border-radius: 12px;">
          <option value="0">Todos</option>
          <option value="4.5">‚≠ê 4.5+</option>
          <option value="4">‚≠ê 4.0+</option>
          <option value="3.5">‚≠ê 3.5+</option>
        </select>
      </label>
      <label>Ordenar por:
        <select id="sort-by" style="min-width: 120px; border-radius: 12px;">
          <option value="rating-desc">Rating ‚Üì</option>
          <option value="rating-asc">Rating ‚Üë</option>
          <option value="reviews-desc">Rese√±as ‚Üì</option>
          <option value="reviews-asc">Rese√±as ‚Üë</option>
          <option value="name-asc">Nombre A-Z</option>
        </select>
      </label>
    </div>

    <div class="layout">
      <div id="vets-scroll-container">
        <div id="vets-list" class="vets-grid">
            <p style="padding:20px; text-align: center;">Escribe una ciudad para comenzar.</p>
        </div>
      </div>
      <div id="map"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjKLaXoimcmWPCcqRF4fkPgdT0oKCVmdM",
      authDomain: "veterimap.firebaseapp.com",
      projectId: "veterimap",
      storageBucket: "veterimap.firebasestorage.app",
      messagingSenderId: "552403666043",
      appId: "1:552403666043:web:1e35d5beba0f4a47850ede"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $city = document.getElementById('vm-city'),
          $service = document.getElementById('vm-service'),
          $apply = document.getElementById('vm-apply'),
          $summary = document.getElementById('vm-summary'),
          $list = document.getElementById('vets-list'),
          $fRating = document.getElementById('filter-rating'),
          $fSort = document.getElementById('sort-by'),
          $datalist = document.getElementById('citySuggestions');

    const map = L.map("map").setView([40.41, -3.70], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    const markersGroup = L.layerGroup().addTo(map);

    let rawData = [];

    // --- AUTOCOMPLETADO FUNCIONAL ---
    $city.addEventListener('input', async () => {
        const query = $city.value.trim();
        if (query.length < 3) return;
        try {
            const resp = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5&lang=es`);
            const data = await resp.json();
            $datalist.innerHTML = data.features
                .filter(f => f.properties.countrycode === 'ES')
                .map(f => `<option value="${f.properties.name}${f.properties.state ? ', ' + f.properties.state : ''}">`)
                .join("");
        } catch (e) { console.error(e); }
    });

    // --- CARGA DE DATOS ---
    async function buscar() {
        const ciudadInput = $city.value.split(',')[0].trim().toLowerCase();
        if (!ciudadInput) return alert("Escribe una ciudad");

        $summary.textContent = "Buscando profesionales...";
        
        try {
            const snap = await getDocs(collection(db, 'coleccion_veterimap'));
            rawData = snap.docs.map(d => ({
                id: d.id,
                ...d.data(),
                nombre: d.data().nombre || d.data().name || "Veterinario",
                rating: parseFloat(d.data().rating || 0),
                reviews: parseInt(d.data().reviews || 0),
                collectionName: d.data().tipoFicha || 'general'
            })).filter(v => (v.ciudad || "").toLowerCase().includes(ciudadInput));

            renderizar();
        } catch (e) { $summary.textContent = "Error de conexi√≥n"; }
    }

    // --- RENDERIZADO CON OPCIONES DE TU CAPTURA ---
    function renderizar() {
        const ratingMin = parseFloat($fRating.value);
        const sortMode = $fSort.value;

        // Definici√≥n de perfiles verificados (Prioridad superior)
        const verifiedTypes = ['fichas_clinicas', 'fichas_24h', 'fichas_hospitales', 'fichas_veterinarios'];
        const isVerified = v => verifiedTypes.includes(v.collectionName) || v.verified === true;

        let list = rawData.filter(v => v.rating >= ratingMin);

        // L√≥gica de ordenaci√≥n exacta de tu captura
        list.sort((a, b) => {
            const av = isVerified(a), bv = isVerified(b);
            if (av && !bv) return -1;
            if (!av && bv) return 1;
            
            switch(sortMode) {
                case "rating-desc": return b.rating - a.rating;
                case "rating-asc": return a.rating - b.rating;
                case "reviews-desc": return b.reviews - a.reviews;
                case "reviews-asc": return a.reviews - b.reviews;
                case "name-asc": return a.nombre.localeCompare(b.nombre);
                default: return 0;
            }
        });

        $list.innerHTML = "";
        markersGroup.clearLayers();
        const bounds = [];

        list.forEach(v => {
            const verified = isVerified(v);
            const card = document.createElement("div");
            card.className = `vet-card ${verified ? 'validated' : ''}`;
            card.innerHTML = `
                <div class="vet-name">
                    ${v.nombre}${verified ? '<span class="verified-check">‚úî</span>' : ''}
                </div>
                <div class="vet-address">üìç ${v.direccion || 'Barcelona, Spain'}</div>
                <div class="vet-meta">‚≠ê ${v.rating.toFixed(1)} (${v.reviews} rese√±as)</div>
                <a href="profile-vet.html?id=${v.id}" class="btn-perfil">Ver Perfil</a>
            `;
            
            card.onclick = (e) => { 
                if(e.target.tagName !== 'A' && v.lat && v.lng) map.flyTo([v.lat, v.lng], 15); 
            };
            
            $list.appendChild(card);
            if (v.lat && v.lng) {
                L.marker([v.lat, v.lng]).addTo(markersGroup).bindPopup(`<b>${v.nombre}</b>`);
                bounds.push([v.lat, v.lng]);
            }
        });

        if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
        $summary.textContent = `Mostrando: ${list.length} resultados en Barcelona`;
    }

    $apply.onclick = buscar;
    $fRating.onchange = renderizar;
    $fSort.onchange = renderizar;
  </script>
</body>
</html>